<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapCook | AI Recipe Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .prose h1 { font-size: 1.5em; font-weight: bold; margin-bottom: 0.5em; color: #1f2937; }
        .prose h2 { font-size: 1.25em; font-weight: 600; margin-top: 1em; margin-bottom: 0.5em; color: #374151; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { color: #ea580c; font-weight: 700; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center p-6">

    <div class="w-full max-w-4xl bg-white border border-gray-200 rounded-xl shadow-sm grid grid-cols-2 divide-x divide-gray-100 mb-8 overflow-hidden">
    
    <div class="p-4 text-center">
        <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Total Chefs</p>
        <p id="stat-total" class="text-2xl font-extrabold text-blue-600">0</p>
    </div>

    <div class="p-4 text-center bg-green-50/50">
        <p class="text-xs text-green-700 uppercase tracking-wider font-semibold">Cache Hits</p>
        <p id="stat-hits" class="text-2xl font-extrabold text-green-600">0</p>
    </div>

    </div>

    <div class="text-center mb-10">
        <h1 class="text-5xl font-extrabold text-gray-900 mb-2 tracking-tight">
            Snap<span class="text-orange-500">Cook</span>
        </h1>
        <p class="text-gray-500 text-lg">Snap a photo. Get the recipe. <span class="text-orange-500 font-medium">Instantly.</span></p>
    </div>

    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg border border-gray-100 transition-all hover:shadow-xl relative">
        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleFileSelect()">
        
        <label for="imageInput" id="dropZone" class="cursor-pointer flex flex-col items-center justify-center h-48 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-orange-50 hover:border-orange-300 transition-colors">
            <div id="uploadText" class="text-center p-4">
                <svg class="w-10 h-10 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <p class="text-sm text-gray-500 font-medium">Click to Upload Food Image</p>
                <p class="text-xs text-gray-400 mt-1">JPG, PNG, WebP supported</p>
            </div>
            <img id="preview" class="h-full w-full object-cover rounded-xl hidden">
        </label>

        <button onclick="analyzeImage()" class="w-full mt-6 bg-gray-900 hover:bg-black text-white font-bold py-3 px-4 rounded-xl shadow-md transition-transform transform active:scale-95 flex items-center justify-center gap-2">
            <span>✨ Generate Recipe</span>
        </button>
    </div>

    <div id="resultContainer" class="w-full max-w-2xl mt-10 hidden opacity-0 transition-opacity duration-500">
        
        <div id="analysisBox" class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 hidden">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">Visual State Analysis</h3>
                    <div id="analysisText" class="mt-1 text-sm text-blue-700 italic">
                        </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 relative">
            <div id="recipeOutput" class="prose prose-orange max-w-none text-gray-700 leading-relaxed">
                </div>
        </div>
    </div>

    <script>
        // --- 1. PREVIEW IMAGE Logic ---
        function handleFileSelect() {
            const input = document.getElementById('imageInput');
            const preview = document.getElementById('preview');
            const uploadText = document.getElementById('uploadText');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    uploadText.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 2. STREAMING LOGIC ---
        let rawMarkdown = ""; // Store raw text to parse periodically

        async function analyzeImage() {
            const input = document.getElementById('imageInput');
            const resultContainer = document.getElementById('resultContainer');
            const output = document.getElementById('recipeOutput');

            if (!input.files[0]) {
                alert("Please select a food image first!");
                return;
            }

            // Reset UI
            resultContainer.classList.remove('hidden');
            setTimeout(() => resultContainer.classList.remove('opacity-0'), 50); // Fade in
            output.innerHTML = '<div class="flex items-center gap-2 text-gray-400 animate-pulse"><div class="w-2 h-2 bg-orange-500 rounded-full"></div> Thinking...</div>';
            rawMarkdown = "";

            const formData = new FormData();
            formData.append("file", input.files[0]);

            try {
                const response = await fetch("/analyze", {
                    method: "POST",
                    body: formData
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                // Clear "Thinking..."
                output.innerHTML = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    rawMarkdown += chunk;
                    
                    // Render Markdown to HTML safely
                    output.innerHTML = marked.parse(rawMarkdown);
                    
                    // Auto-scroll
                    // window.scrollTo(0, document.body.scrollHeight);
                }
            } catch (err) {
                output.innerHTML = `<p class="text-red-500 font-bold">❌ Error: ${err.message}</p>`;
            }
        }

        // --- 3. METRICS LOGIC ---
        async function refreshStats() {
            try {
                let res = await fetch('/stats');
                let data = await res.json();
                document.getElementById('stat-total').innerText = data.total_requests;
                document.getElementById('stat-hits').innerText = data.cache_hits;
                // document.getElementById('stat-time').innerText = data.time_saved_seconds + "s";
            } catch (e) { console.error("Stats error", e); }
        }
        setInterval(refreshStats, 3000);
        refreshStats();
    </script>
</body>
</html>